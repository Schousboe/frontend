---
import Layout from "~/layouts/Layout.astro";
import Section from "~/components/Section.astro";
import { getCollection } from "astro:content";

const repoGroups = await getCollection("repos");
const repoCards = repoGroups.flatMap((group) =>
	group.data.repos.map((repo) => ({
		...repo,
		group: group.data.prettyName,
	}))
);

const paperUrl = "https://paper.voxelearth.org";
const gitHubOrgUrl = "https://github.com/VoxelEarth";

const paperCard = {
	name: "Voxel Earth Research Paper",
	description: "Dive into the full technical write-up covering GPU voxelization, streaming, and reconstruction math.",
	url: paperUrl,
	group: "Research",
	starCount: undefined,
	accent: true,
};

const cards = [...repoCards, paperCard];
const numberFormatter = new Intl.NumberFormat("en-US");

const pageMeta = {
	title: "Code",
	pageTitle: "Code | Voxel Earth",
	description: "Browse every Voxel Earth repository, from GPU voxelizers to Minecraft plugins and web viewers.",
};
---

<Layout title={pageMeta.title} pageTitle={pageMeta.pageTitle} description={pageMeta.description}>
	<Section class="bg-white text-slate-900">
		<div class="mx-auto max-w-4xl space-y-6 text-center">
			<p class="text-sm uppercase tracking-[0.35em] text-slate-500">Open Source Stack</p>
			<h1 class="text-4xl font-black text-brand-green md:text-5xl">Voxel Earth Code</h1>
			<p class="text-lg text-slate-600 md:text-xl">
				Snappy GPU kernels, Minecraft plugins, and web viewers that turn real-world photogrammetry into playable
				voxel terrain. Tap a tile to explore every repository.
			</p>
			<div class="flex flex-wrap justify-center gap-4 pt-2 mb-6">
				<a
					href={gitHubOrgUrl}
					target="_blank"
					rel="noopener noreferrer"
					class="inline-flex items-center gap-2 rounded-full border border-brand-green/30 bg-white px-6 py-3 text-sm font-semibold uppercase tracking-[0.25em] text-slate-900 transition hover:bg-brand-green/10"
				>
					GitHub Org
					<svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 17 17 7M9 7h8v8" />
					</svg>
				</a>
				<a
					href={paperUrl}
					target="_blank"
					rel="noopener noreferrer"
					class="inline-flex items-center gap-2 rounded-full bg-brand-green/90 px-6 py-3 text-sm font-semibold uppercase tracking-[0.25em] text-white transition hover:bg-brand-green"
				>
					Read the Paper
					<svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 17 17 7M9 7h8v8" />
					</svg>
				</a>
			</div>
		</div>
	</Section>

	<Section class="bg-[#F4F8F2]">
		<div class="grid grid-cols-1 gap-6 sm:grid-cols-2 xl:grid-cols-3">
			{cards.map((card) => (
				<a
					href={card.url}
					target="_blank"
					rel="noopener noreferrer"
					class={`group relative flex min-h-[240px] flex-col justify-between rounded-[28px] border p-6 shadow-xl transition duration-200 hover:-translate-y-1.5 hover:border-brand-green hover:shadow-[0_24px_45px_rgba(21,127,113,0.2)] ${
						card.accent ? "bg-gradient-to-br from-emerald-100 via-lime-50 to-amber-100 text-slate-900 border-transparent" : "bg-white text-slate-900 border-brand-green/20"
					}`}
					aria-label={`Open ${card.name}`}
				>
					<div>
						<p class={`text-xs font-semibold uppercase tracking-[0.4em] ${card.accent ? "text-slate-900/70" : "text-brand-green/70"}`}>
							{card.group}
						</p>
						<h2 class={`mt-4 text-2xl font-semibold ${card.accent ? "text-slate-900" : "text-slate-900"}`}>{card.name}</h2>
						<p class={`mt-3 text-base leading-relaxed ${card.accent ? "text-slate-900/80" : "text-slate-700"}`}>{card.description}</p>
					</div>

					<div class="mt-6 flex items-center justify-between text-sm font-semibold">
						<div class={`flex items-center gap-2 ${card.accent ? "text-slate-900/75" : "text-slate-600"}`}>
							{typeof card.starCount === "number" ? (
								<>
									<svg width="18" height="18" viewBox="0 0 24 24" class="text-yellow-300" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
										<path d="m12 2.25 2.47 6.32 6.78.19-5.27 4.34 1.83 6.45L12 15.77 6.19 19.55l1.83-6.45-5.27-4.34 6.78-.19z" />
									</svg>
									<span>{numberFormatter.format(card.starCount)} stars</span>
								</>
							) : (
								<span class="inline-flex items-center gap-2">
									<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="text-current" stroke-width="1.5" aria-hidden="true">
										<path d="M5 12h14M5 12a7 7 0 0 1 7-7v0a7 7 0 0 1 7 7M5 12a7 7 0 0 0 7 7v0a7 7 0 0 0 7-7" stroke-linecap="round" stroke-linejoin="round" />
									</svg>
									<span>Deep dive</span>
								</span>
							)}
						</div>
						<span class={`inline-flex items-center gap-1 transition ${card.accent ? "text-slate-900" : "text-brand-green"}`}>
							{card.accent ? "Open paper" : "Open repo"}
							<svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 17 17 7M9 7h8v8" />
							</svg>
						</span>
					</div>
				</a>
			))}
		</div>
	</Section>
</Layout>
